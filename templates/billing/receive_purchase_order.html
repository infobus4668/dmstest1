{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock title %}

{% block extra_head %}
<style>
    .item-receive-table th, .item-receive-table td {
        white-space: nowrap;
        vertical-align: middle;
    }
    .item-receive-table input[type="number"] {
        max-width: 110px;
        text-align: right;
    }
    .item-receive-table input[type="text"], .item-receive-table input[type="date"] {
        min-width: 140px;
    }
    .final-cost-cell {
        font-weight: bold;
        background-color: #f0f8ff;
        vertical-align: middle;
        text-align: right !important;
        min-width: 120px;
        font-size: 1.1em;
        color: var(--primary-color-dark);
    }
    .apply-all-bar {
        background: #f8f9fa;
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .apply-all-bar label { margin-bottom: 0; font-weight: 600; }
    .apply-all-bar input { width: 100px; }
    .details-row { display: none; }
    .details-row-content {
        background-color: #fafcff;
        padding: 20px;
        border: 1px solid #eef;
        border-top: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
    }
    .error-row-highlight {
        border-left: 3px solid var(--danger-color) !important;
        background-color: #fff2f2;
    }
    .form-row-error {
        list-style-type: none;
        margin: 0 0 20px 0;
        padding: 10px 15px;
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
    }
    .form-row-error li {
        margin-bottom: 5px;
    }
    .required-indicator {
        color: var(--danger-color);
        font-weight: bold;
        margin-left: 5px;
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="detail-card" style="max-width: none; margin: 20px auto;">
    <div class="detail-card-header">
        <h3 style="font-size: 1.75em;">{{ page_title }}</h3>
    </div>
    <p style="color: var(--text-color-light); margin-top: -10px; margin-bottom: 20px;">
        For each item from supplier <strong>{{ purchase_order.supplier.name }}</strong> (PO #{{ purchase_order.pk }}), 
        enter the quantity received and financial details from the supplier's bill.
    </p>

    <div class="apply-all-bar">
        <label>Apply to all items:</label>
        <input type="number" step="0.01" class="form-control" id="master-discount" placeholder="Disc. %">
        <input type="number" step="0.01" class="form-control" id="master-gst" placeholder="GST %">
        <button type="button" id="apply-to-all-btn" class="button button-info"><i class="fas fa-check-double"></i> Apply</button>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}
        {% if formset.non_form_errors %}
            <ul class="messages"><li class="error">{{ formset.non_form_errors.as_text }}</li></ul>
        {% endif %}

        <div class="table-responsive">
            <table class="table table-bordered item-receive-table">
                <thead class="table-light">
                    <tr>
                        <th style="min-width: 250px;">Product Variant</th>
                        <th>{{ formset.forms.0.quantity_to_receive.label }}</th>
                        <th>{{ formset.forms.0.batch_number.label }}</th>
                        <th>{{ formset.forms.0.mrp.label }}</th>
                        <th>{{ formset.forms.0.base_cost_price.label }}</th>
                        <th>{{ formset.forms.0.discount_percentage.label }}</th>
                        <th>{{ formset.forms.0.discount_amount.label }}</th>
                        <th>{{ formset.forms.0.gst_percentage.label }}</th>
                        <th>Final Cost / Unit</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form, item in forms_with_items %}
                    <tr class="item-form-row {% if form.errors %}error-row-highlight{% endif %}">
                        <td style="vertical-align: middle;">
                            {{ form.purchase_order_item_id }}
                            <strong>{{ item.product_variant }}</strong><br>
                            <small class="text-muted">Ordered: {{ item.quantity }} | Remaining: {{ item.quantity_remaining }}</small>
                        </td>
                        <td>{{ form.quantity_to_receive }}</td>
                        <td>{{ form.batch_number }}</td>
                        <td>{{ form.mrp }}</td>
                        <td>{{ form.base_cost_price }}</td>
                        <td>{{ form.discount_percentage }}</td>
                        <td>{{ form.discount_amount }}</td>
                        <td>{{ form.gst_percentage }}</td>
                        <td class="final-cost-cell">
                            â‚¹<span class="final-cost-value">0.00</span>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-secondary toggle-details-btn" title="Show/Hide More Details">
                                {% if form.errors %}<i class="fas fa-exclamation-triangle text-danger"></i>{% else %}<i class="fas fa-chevron-down"></i>{% endif %}
                            </button>
                        </td>
                    </tr>
                    <tr class="details-row">
                        <td colspan="10">
                            <div class="details-row-content">
                                {% if form.errors %}
                                <div style="grid-column: 1 / -1;">
                                    <ul class="form-row-error">
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                <div class="field-container">
                                    <label for="{{ form.expiry_date.id_for_label }}">
                                        Expiry Date
                                        <span class="required-indicator" id="expiry-req-{{ forloop.counter0 }}" style="display: none;">*</span>
                                    </label>
                                    {{ form.expiry_date }}
                                </div>
                                <div class="field-container">
                                    <label for="{{ form.date_received.id_for_label }}">Date of Receipt</label>
                                    {{ form.date_received }}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="main-actions-bar" style="justify-content: flex-end;">
            <a href="{% url 'billing:purchase_order_detail' pk=purchase_order.pk %}" class="button button-secondary">Cancel</a>
            <button type="submit" class="button button-success">Save Received Stock</button>
        </div>
    </form>
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Show required indicator for expiry date based on product type
    const expiryMap = JSON.parse('{{ expiry_map_json|escapejs }}');
    $('.item-form-row').each(function(index) {
        const row = $(this);
        const poItemId = row.find('input[name$="-purchase_order_item_id"]').val();
        const indicator = row.next('.details-row').find(`#expiry-req-${index}`);
        
        if (expiryMap[poItemId] && indicator.length) {
            indicator.show();
        }
    });

    function calculateFinalCost(row) {
        const baseCost = parseFloat(row.find('input[name$="-base_cost_price"]').val()) || 0;
        const discountPerc = parseFloat(row.find('input[name$="-discount_percentage"]').val()) || 0;
        const discountAmt = parseFloat(row.find('input[name$="-discount_amount"]').val()) || 0;
        const qty = parseFloat(row.find('input[name$="-quantity_to_receive"]').val()) || 0;
        const gst = parseFloat(row.find('input[name$="-gst_percentage"]').val()) || 0;
        const finalCostSpan = row.find('.final-cost-value');

        let finalDiscountPerc = discountPerc;
        if (discountAmt > 0 && baseCost > 0 && qty > 0) {
            const perUnitDiscount = discountAmt / qty;
            finalDiscountPerc = (perUnitDiscount / baseCost) * 100;
        }
        const costAfterDiscount = baseCost * (1 - (finalDiscountPerc / 100));
        const finalCost = costAfterDiscount * (1 + (gst / 100));
        finalCostSpan.text(finalCost.toFixed(2));
    }

    $('.toggle-details-btn').on('click', function() {
        const icon = $(this).find('i');
        const detailsRow = $(this).closest('.item-form-row').next('.details-row');
        detailsRow.slideToggle(200);
        if (!icon.hasClass('fa-exclamation-triangle')) {
            icon.toggleClass('fa-chevron-down fa-chevron-up');
        }
    });

    function handleDiscountInputs(row) {
        const discountPercInput = row.find('input[name$="-discount_percentage"]');
        const discountAmtInput = row.find('input[name$="-discount_amount"]');
        discountPercInput.on('input', function() {
            if ($(this).val()) { discountAmtInput.prop('disabled', true).val(''); } 
            else { discountAmtInput.prop('disabled', false); }
            calculateFinalCost(row);
        });
        discountAmtInput.on('input', function() {
            if ($(this).val()) { discountPercInput.prop('disabled', true).val(''); } 
            else { discountPercInput.prop('disabled', false); }
            calculateFinalCost(row);
        });
    }

    $('#apply-to-all-btn').on('click', function() {
        const masterDiscount = $('#master-discount').val();
        const masterGst = $('#master-gst').val();
        $('.item-form-row').each(function() {
            const row = $(this);
            if (masterDiscount) {
                row.find('input[name$="-discount_percentage"]').val(masterDiscount).trigger('input');
            }
            if (masterGst) {
                row.find('input[name$="-gst_percentage"]').val(masterGst).trigger('input');
            }
        });
    });

    $('.item-form-row').each(function() {
        const row = $(this);
        row.on('input', 'input', function() {
            calculateFinalCost(row);
        });
        handleDiscountInputs(row);
        calculateFinalCost(row);
    });
});
</script>
{% endblock extra_js %}