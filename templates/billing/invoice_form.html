{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock title %}

{% block content %}
<form method="POST" id="invoice-form">
    {% csrf_token %}
    {{ invoice_form.media }}
    {{ formset.media }}

    <div class="details-header-card">
        <div class="patient-info">
             <h2>{{ page_title }}</h2>
        </div>
    </div>

    <div class="details-grid-block">
        <div class.main-details">
            <div class="detail-card">
                <div class="detail-card-header"><h3>Invoice Details</h3></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    {% for field in invoice_form %}
                        <div class="field-container">{{ field.label_tag }}{{ field }}{{ field.errors }}</div>
                    {% endfor %}
                </div>
            </div>

            <div class="detail-card">
                <div class="detail-card-header">
                    <h3>Invoice Items</h3>
                </div>
                <div id="invoice-items-container">
                    {{ formset.management_form }}
                    {% for form in formset %}
                        <div class="formset-row invoice-item-card">
                            {% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}
                            <div style="display:none;">{{ form.DELETE }}</div>
                            <div class="invoice-row-grid">
                                <div class="field-container service-cell">{{ form.service.label_tag }}{{ form.service }}</div>
                                <div class="field-container product-cell">{{ form.product_variant.label_tag }}{{ form.product_variant }}</div>
                                <div class="field-container stock-cell">{{ form.stock_item.label_tag }}{{ form.stock_item }}</div>
                                <div class="field-container desc-cell">{{ form.description.label_tag }}{{ form.description }}</div>
                                <div class="field-container qty-cell">{{ form.quantity.label_tag }}{{ form.quantity }}</div>
                                <div class="field-container price-cell">{{ form.unit_price.label_tag }}{{ form.unit_price }}</div>
                                <div class="field-container discount-cell">{{ form.discount.label_tag }}{{ form.discount }}</div>
                                <div class="field-container remove-btn-cell">
                                    <button type="button" class="remove-row-btn button button-danger"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                    <button type="button" class="add-row-button button button-primary" id="add-item-button">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>

                <template id="empty-form-template">
                    <div class="formset-row invoice-item-card">
                        {% for hidden_field in formset.empty_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                        <div style="display:none;">{{ formset.empty_form.DELETE }}</div>
                        <div class="invoice-row-grid">
                            <div class="field-container service-cell">{{ formset.empty_form.service.label_tag }}{{ formset.empty_form.service }}</div>
                            <div class="field-container product-cell">{{ formset.empty_form.product_variant.label_tag }}{{ formset.empty_form.product_variant }}</div>
                            <div class="field-container stock-cell">{{ formset.empty_form.stock_item.label_tag }}{{ formset.empty_form.stock_item }}</div>
                            <div class="field-container desc-cell">{{ formset.empty_form.description.label_tag }}{{ formset.empty_form.description }}</div>
                            <div class="field-container qty-cell">{{ formset.empty_form.quantity.label_tag }}{{ formset.empty_form.quantity }}</div>
                            <div class="field-container price-cell">{{ formset.empty_form.unit_price.label_tag }}{{ formset.empty_form.unit_price }}</div>
                            <div class="field-container discount-cell">{{ formset.empty_form.discount.label_tag }}{{ formset.empty_form.discount }}</div>
                            <div class="field-container remove-btn-cell">
                                <button type="button" class="remove-row-btn button button-danger"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div class="live-summary-footer">
        <div class="summary-item">
            <strong>Subtotal:</strong>
            <span id="summary-subtotal">₹0.00</span>
        </div>
        <div class="summary-item">
            <strong>Total Discount:</strong>
            <span id="summary-discount">₹0.00</span>
        </div>
        <div class="summary-item summary-item-net">
            <strong>Net Amount:</strong>
            <span id="summary-net">₹0.00</span>
        </div>
    </div>

    <div class="main-actions-bar">
        {% if object %}
            <a href="{% url 'billing:invoice_detail' pk=object.pk %}" class="button button-secondary"><i class="fas fa-times"></i> Cancel</a>
        {% else %}
             <a href="{% url 'billing:invoice_list' %}" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Invoice List</a>
        {% endif %}
        <button type="submit" class="button button-success">
            {% if object %}<i class="fas fa-save"></i> Save Changes{% else %}<i class="fas fa-check"></i> Create Invoice{% endif %}
        </button>
    </div>
</form>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<style>
.details-grid-block { 
    display: block;
    margin-bottom: 120px;
}
.invoice-item-card { 
    background: #fafbfc; 
    border: 1px solid #e3e7ed; 
    border-radius: 8px; 
    margin-bottom: 1rem; 
    padding: 1.25rem; 
    position: relative;
}
.invoice-row-grid { 
    display: grid;
    grid-template-columns: 1.5fr 1.5fr 1.5fr 2fr 0.6fr 0.8fr 0.8fr 0.4fr;
    gap: 1rem; 
    align-items: flex-start;
}
.remove-btn-cell {
    padding-top: 1.75rem;
}
.stock-cell {
    visibility: hidden;
    transition: visibility 0.1s;
}
.stock-cell.visible {
    visibility: visible;
}
</style>
<script type="text/javascript">
$(document).ready(function() {
    const itemData = JSON.parse('{{ js_data|escapejs }}');
    const container = $('#invoice-items-container');

    function updateLiveSummary() {
        let subtotal = 0, itemDiscountTotal = 0;
        container.find('.formset-row:visible').each(function() {
            const row = $(this);
            if (row.find('input[name$="-DELETE"]').is(':checked')) return;
            
            const qty = parseFloat(row.find('input[name$="-quantity"]').val()) || 1;
            const price = parseFloat(row.find('input[name$="-unit_price"]').val()) || 0;
            const discount = parseFloat(row.find('input[name$="-discount"]').val()) || 0;
            subtotal += qty * price;
            itemDiscountTotal += qty * discount;
        });

        const invoiceDiscount = parseFloat($('#id_discount').val()) || 0;
        const totalDiscount = itemDiscountTotal + invoiceDiscount;
        $('#summary-subtotal').text('₹' + subtotal.toFixed(2));
        $('#summary-discount').text('₹' + totalDiscount.toFixed(2));
        $('#summary-net').text('₹' + (subtotal - totalDiscount).toFixed(2));
    }

    function attachRowListeners(row) {
        const serviceSelect = row.find('select[name$="-service"]');
        const productSelect = row.find('select[name$="-product_variant"]');
        const stockSelect = row.find('select[name$="-stock_item"]');
        const descInput = row.find('input[name$="-description"]');
        const priceInput = row.find('input[name$="-unit_price"]');
        const stockCell = row.find('.stock-cell');

        serviceSelect.on('change', function() {
            const serviceId = $(this).val();
            if (serviceId) {
                productSelect.prop('disabled', true).val(null).trigger('change.select2');
                const service = itemData.services[serviceId];
                if (service) {
                    descInput.val(service.name);
                    priceInput.val(service.price).trigger('change');
                }
            } else {
                productSelect.prop('disabled', false);
            }
        });

        productSelect.on('change', function() {
            const variantId = $(this).val();
            stockSelect.empty().append('<option value=""></option>').trigger('change');
            
            if (variantId) {
                serviceSelect.prop('disabled', true).val(null).trigger('change.select2');
                stockCell.addClass('visible');
                stockSelect.prop('disabled', false);
                if (itemData.batches[variantId]?.length > 0) {
                    itemData.batches[variantId].forEach(batch => {
                        const optionText = `${batch.name} (Avail: ${batch.available})`;
                        stockSelect.append(new Option(optionText, batch.pk));
                    });
                }
            } else {
                serviceSelect.prop('disabled', false);
                stockCell.removeClass('visible');
                stockSelect.prop('disabled', true);
            }
        });

        stockSelect.on('change', function() {
            const stockId = $(this).val();
            const variantId = productSelect.val();
            if (stockId && variantId) {
                const batch = itemData.batches[variantId]?.find(b => String(b.pk) === stockId);
                const product = itemData.products[variantId];
                if (batch && product) {
                    priceInput.val(batch.mrp).trigger('change');
                    descInput.val(product.name);
                }
            } else if (!serviceSelect.val()) {
                priceInput.val('').trigger('change');
                descInput.val('');
            }
        });
    }

    // Initialize existing rows
    container.find('.formset-row').each(function() {
        attachRowListeners($(this));
    });

    // Handle adding new rows
    $('#add-item-button').on('click', function() {
        const totalForms = $('#id_items-TOTAL_FORMS');
        let formIdx = parseInt(totalForms.val(), 10);
        
        const newRowHtml = $('#empty-form-template').html().replace(/__prefix__/g, formIdx);
        const newRow = $(newRowHtml);
        container.append(newRow);
        
        // Let django-select2 initialize the new widgets
        newRow.find('.django-select2').djangoSelect2();
        
        // Attach our custom logic
        attachRowListeners(newRow);
        
        totalForms.val(formIdx + 1);
    });

    // Handle removing rows
    container.on('click', '.remove-row-btn', function() {
        const row = $(this).closest('.formset-row');
        row.hide().find('input[name$="-DELETE"]').prop('checked', true);
        updateLiveSummary();
    });

    // Update summary on any form change
    $('#invoice-form').on('change input', 'input, select', updateLiveSummary);

    // Initial summary calculation
    updateLiveSummary();
});
</script>
{% endblock extra_js %}